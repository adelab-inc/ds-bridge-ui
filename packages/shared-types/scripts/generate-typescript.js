#!/usr/bin/env node
/**
 * Generate TypeScript files from JSON source
 * Usage: node generate-typescript.js
 */

const fs = require('fs');
const path = require('path');

const FIREBASE_DIR = path.join(__dirname, '../firebase');
const OUTPUT_DIR = path.join(__dirname, '../typescript/firebase');

// Ensure output directory exists
if (!fs.existsSync(OUTPUT_DIR)) {
  fs.mkdirSync(OUTPUT_DIR, { recursive: true });
}

/**
 * Helper: Convert snake_case to PascalCase
 */
function snakeToPascalCase(str) {
  return str
    .split('_')
    .map(word => word.charAt(0).toUpperCase() + word.slice(1))
    .join('');
}

/**
 * Helper: Generate TypeScript type from schema field
 */
function generateFieldType(field) {
  if (field.type === 'string') return 'string';
  if (field.type === 'boolean') return 'boolean';
  if (field.type === 'number') return 'number';
  if (field.type === 'timestamp') return 'Timestamp';
  if (field.type === 'enum' && field.values) {
    return field.values.map(v => `'${v}'`).join(' | ');
  }
  return 'any';
}

/**
 * Helper: Generate TypeScript interface from schema
 */
function generateInterface(collectionKey, schema) {
  const interfaceName = snakeToPascalCase(collectionKey) + 'Document';
  
  const fields = Object.entries(schema)
    .map(([fieldName, fieldConfig]) => {
      const type = generateFieldType(fieldConfig);
      const optional = !fieldConfig.required ? '?' : '';
      const comment = fieldConfig.description ? `\n  /** ${fieldConfig.description} */` : '';
      return `${comment}\n  ${fieldName}${optional}: ${type};`;
    })
    .join('\n');

  return `export interface ${interfaceName} {${fields}\n}`;
}

/**
 * Generate collections.ts
 */
function generateCollections() {
  const collectionsJson = JSON.parse(
    fs.readFileSync(path.join(FIREBASE_DIR, 'collections.json'), 'utf-8')
  );

  // Generate COLLECTIONS constant
  const entries = Object.entries(collectionsJson.collections)
    .map(([key, value]) => `  ${key.toUpperCase()}: '${value.name}'`)
    .join(',\n');

  // Generate interfaces from schemas
  const interfaces = Object.entries(collectionsJson.collections)
    .filter(([_, value]) => value.schema)
    .map(([key, value]) => generateInterface(key, value.schema))
    .join('\n\n');

  const hasTimestamp = JSON.stringify(collectionsJson).includes('"type": "timestamp"');
  const timestampImport = hasTimestamp ? "import { Timestamp } from 'firebase/firestore';\n\n" : '';

  const output = `/**
 * Firebase Firestore Collection Names and Document Types
 *
 * ‚ö†Ô∏è AUTO-GENERATED - DO NOT EDIT MANUALLY
 * Source: packages/shared-types/firebase/collections.json
 * Generated by: scripts/generate-typescript.js
 */

${timestampImport}export const COLLECTIONS = {
${entries}
} as const;

export type CollectionName = typeof COLLECTIONS[keyof typeof COLLECTIONS];

${interfaces}
`;

  fs.writeFileSync(path.join(OUTPUT_DIR, 'collections.ts'), output);
  console.log('‚úÖ Generated: typescript/firebase/collections.ts');
}

/**
 * Generate storage.ts
 */
function generateStorage() {
  const storageJson = JSON.parse(
    fs.readFileSync(path.join(FIREBASE_DIR, 'storage.json'), 'utf-8')
  );

  const entries = Object.entries(storageJson.paths)
    .map(([key, value]) => `  ${key.toUpperCase()}: '${value.path}'`)
    .join(',\n');

  const output = `/**
 * Firebase Storage Paths
 *
 * ‚ö†Ô∏è AUTO-GENERATED - DO NOT EDIT MANUALLY
 * Source: packages/shared-types/firebase/storage.json
 * Generated by: scripts/generate-typescript.js
 */

export const STORAGE_PATHS = {
${entries}
} as const;

export type StoragePath = typeof STORAGE_PATHS[keyof typeof STORAGE_PATHS];
`;

  fs.writeFileSync(path.join(OUTPUT_DIR, 'storage.ts'), output);
  console.log('‚úÖ Generated: typescript/firebase/storage.ts');
}

/**
 * Generate index.ts
 */
function generateIndex() {
  const output = `/**
 * Firebase Shared Configuration
 *
 * ‚ö†Ô∏è AUTO-GENERATED - DO NOT EDIT MANUALLY
 * Generated by: scripts/generate-typescript.js
 */

export * from './collections';
export * from './storage';
`;

  fs.writeFileSync(path.join(OUTPUT_DIR, 'index.ts'), output);
  console.log('‚úÖ Generated: typescript/firebase/index.ts');
}

// Run
try {
  console.log('üîÑ Generating TypeScript files...\n');
  generateCollections();
  generateStorage();
  generateIndex();
  console.log('\n‚ú® TypeScript generation complete!');
} catch (error) {
  console.error('‚ùå Error generating TypeScript files:', error.message);
  process.exit(1);
}
